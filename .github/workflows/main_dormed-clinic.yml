name: Build and deploy Dormed Clinic app to Oracle VM


on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest


    steps:
      - uses: actions/checkout@v2

      - name: Set up Python version
        uses: actions/setup-python@v1
        with:
          python-version: '3.12'

      - name: Create and start virtual environment
        run: |
          echo "Creating virtual environment"
          python -m venv venv
          source venv/bin/activate
      
      - name: Install dependencies
        run: |
          echo "Installing dependencies"
          pip install -r requirements.txt
      
      - name: Install Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'
      
      - name: Install and build frontend
        working-directory: frontend
        run: |
            echo "Installing and building frontend"
            npm install
            npm run build
            cd ..

      - name: Upload artifact for deployment jobs
        uses: actions/upload-artifact@v2
        with:
          name: django-react-app
          path: |
            . 
            !venv/

  deploy:
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Download artifact from build job
        uses: actions/download-artifact@v2
        with:
          name: django-react-app
          path: .
      - name: Set up SSH
        run: |
          echo "Setting up SSH"
          mkdir -p ~/.ssh
          echo "${{ secrets.ORACLE_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.ORACLE_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy to Oracle VM
        run: |
          echo "Deploying to Oracle VM"
          ssh ${{ secrets.ORACLE_USER }}@${{ secrets.ORACLE_HOST }} << 'EOF'

          # Paths
          PROJECT_DIR=/home/${USER}/app
          BACKEND_DIR=$PROJECT_DIR/backend
          FRONTEND_DIR=$PROJECT_DIR/frontend
          VENV_DIR=$BACKEND_DIR/venv

          # If project folder doesn't exist, create and clone repo
          echo "Checking for project folder"
          if [ ! -d "$PROJECT_DIR" ]; then
            mkdir -p $PROJECT_DIR
            git clone git@github.com:<username>/<repo>.git $PROJECT_DIR
          fi

          cd $PROJECT_DIR
          echo "Checking for repo"
          git pull origin main

          # Frontend build
          cd $FRONTEND_DIR
          npm install
          npm run build

          # Backend setup
          echo "Setting up backend"
          cd $BACKEND_DIR
          if [ ! -d "$VENV_DIR" ]; then
            python3 -m venv venv
          fi
          source venv/bin/activate
          pip install -r ../requirements.txt
          python manage.py migrate
          python manage.py collectstatic --noinput
          deactivate

          # Restart Gunicorn
          sudo systemctl restart gunicorn

          EOF

          
